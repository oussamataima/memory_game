<script setup lang="ts">
import Circle from "@/components/Circle.vue";
import { h, onMounted, ref, watch , reactive } from "vue";
import { generateNumbers } from "@/lib";
import type { NumberObject, player } from "@/types";
import { twMerge } from "tailwind-merge";
import { useRoute, useRouter } from "vue-router";
const props = defineProps({
  numPlayers: {
    type: Number,
    default: 1,
  },
  grid: {
    type: Number,
    default: 4,
  },
  theme: {
    type: String,
    default: "numbers",
  },
});

import { FontAwesomeIcon } from "@fortawesome/vue-fontawesome";



// const elements = ref<NumberObject[]>(generateNumbers(props.grid ** 2 / 2, 20));
// const selectedNumbers = ref<NumberObject[]>([]);
// const matchedPairs = ref<NumberObject[]>([]);
// const lastMatchedPair = ref<{ num1: string; num2: string } | null>(null);
// const matchedCount = ref(0);
// const moveCount = ref(0);
const timer = ref({ hours: 0, minutes: 0, seconds: 0 });
const player1 = reactive<player>({
  elements: generateNumbers(props.grid ** 2 / 2, 20) ,
  selectedNumbers: [],
  matchedPairs: [],
  lastMatchedPair: null,
  matchedCount: 0,
  moveCount: 0,
  timer: { hours: 0, minutes: 0, seconds: 0 },
});
const player2 = ref();
const player3 = ref(
);
const player4 = ref(
);


function updateTimer() {
  const { hours, minutes, seconds } = player1.timer;
  if (seconds < 59) {
    player1.timer.seconds++;
  } else if (minutes < 59) {
    player1.timer.seconds = 0;
    player1.timer.minutes++;
  } else if (hours < 23) {
    player1.timer.seconds = 0;
    player1.timer.minutes = 0;
    player1.timer.hours++;
  }
}
let timerInterval = setInterval(() => {
  updateTimer();
}, 1000);

function revealNumber(id: string) {
  const number = player1.elements.find((num) => num.id === id);
  const isAlreadyMatched = player1.matchedPairs.some((num) => num.id === id);
  if (number && number.variant !== "matched" && !isAlreadyMatched) {
    const isAlreadySelected = player1.selectedNumbers.some((num) => num.id === number.id);
    if (!isAlreadySelected) {
      player1.moveCount++;
      player1.selectedNumbers.push(number);
    }
    number.variant = "visible";
    checkMatch();
  }
}

watch(player1.matchedPairs, () => {
  // console.log(player1.elements);
  // const { num1, num2 } = player1.lastMatchedPair || {};
  const num1 = player1.lastMatchedPair?.num1;
  const num2 = player1.lastMatchedPair?.num2;
  if (num1 && num2) {
    unmarkNumbers();
    markMatched(num1);
    markMatched(num2);
  }
});
watch(player1.matchedPairs, () => {
  if (isAllMatched()) {
    clearInterval(timerInterval);
  }
});

function checkMatch() {
  if (player1.selectedNumbers.length === 2) {
    const [first, second] = player1.selectedNumbers;
    // console.log(first, second);
    if (first.value === second.value) {
      player1.matchedPairs.push(first, second);
      player1.lastMatchedPair = { num1: first.id, num2: second.id };
      player1.matchedCount++;
    } else {
      setTimeout(() => {
        first.variant = "hidden";
        second.variant = "hidden";
      }, 300);
    }
    player1.selectedNumbers = [];
  }
}

function markMatched(id: string) {
  const number = player1.elements.find((num) => num.id === id);
  console.log(number);
  if (number) {
    number.variant = "matched";
    number.matched = true;
  }
}

function unmarkNumbers() {
  player1.elements.forEach((num) => {
    if (num.variant === "matched") {
      num.variant = "visible";
    }
  });
}
function isAllMatched() {
  return player1.elements.every((num) => num.matched);
}
</script>

<template>
  <main class="max-w-[1110px] mx-auto">
    <header class="flex justify-between items-center mt-8">
      <h1 class="text-center text-darkBlue text-[32px] font-bold">memory</h1>
      <div class="flex gap-4">
        <button
          class="bg-yellowOrange text-white rounded-3xl py-3.5 px-7 font-bold text-xl"
        >
          Restart
        </button>
        <button
          class="bg-darkLightGray text-tealBlue rounded-3xl py-3.5 px-7 font-bold text-xl"
        >
          New Game
        </button>
      </div>
    </header>
    <section
      :class="
        twMerge(
          'flex gap-4 flex-wrap max-w-[572px] mx-auto my-16',
          props.grid == 4 ? 'max-w-[532px]' : 'max-w-[  572px]'
        )
      "
    >
      <Circle
        v-for="number in player1.elements"
        :theme="props.theme as 'numbers' | 'icons'"
        :key="number.id"
        :value="number.value"
        :grid="props.grid"
        :variant="number.variant as 'hidden' | 'visible' | 'matched' "
        @click="
          () => {
            revealNumber(number.id);
          }
        "
      >
      <div v-if="number.variant !== 'hidden'">
        <p v-if="theme === 'numbers'" >{{ number.value }}</p>
        <font-awesome-icon v-else :icon="['fas', number.icon]" />
      </div>
      </Circle>
    </section>
    <section class="flex gap-[30px] mx-auto w-fit">
      <div
        class="flex justify-between items-center md:min-w-[255px] bg-darkLightGray p-5 rounded-[10px]"
      >
        <span class="text-blueDarkGray text-xl font-bold">Time</span>
        <span class="text-tealBlue text-xl font-bold">{{ player1.timer }}</span>
      </div>
      <div
        class="flex justify-between items-center md:min-w-[255px] bg-darkLightGray p-5 rounded-[10px]"
      >
        <span class="text-blueDarkGray text-xl font-bold">Moves</span>
        <span class="text-tealBlue text-xl font-bold">{{ player1.moveCount }}</span>
      </div>
    </section>
  </main>
</template>
<style scoped>
body {
  background-color: #fcfcfc;
}
</style>
